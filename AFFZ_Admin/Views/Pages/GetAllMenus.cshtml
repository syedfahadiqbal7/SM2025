<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.27/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.27/dist/sweetalert2.all.min.js"></script>
<style>
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }
</style>
@model List<AFFZ_Admin.Controllers.MenuViewModel>
<div class="page-wrapper page-settings">
    <div class="content">
        <!-- Customer Table -->
        <div class="">
            <div class="content-page-header content-page-headersplit mb-0">
                <h5 style="color:#000">Menu Management</h5>
                <div class="list-btn">
                    <ul>
                        <li>
                            <div class="filter-sorting">
                                <ul>
                                    <li>
                                        <a href="javascript:void(0);" class="filter-sets"><img src="assets/img/icons/filter1.svg" class="me-2" alt="img">Filter</a>
                                    </li>
                                    <li>
                                        <span><img src="assets/img/icons/sort.svg" class="me-2" alt="img"></span>
                                        <div class="review-sort">
                                            <select class="select">
                                                <option>A -> Z</option>
                                                <option>Z -> A</option>
                                            </select>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li>
                            <a href="javascript:void(0);" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMenuModal" id="openAddMenuModal">
                                <i class="fa fa-plus me-2"></i>Add New Menu
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th>#</th>
                                <th>Menu Name</th>
                                <th>URL</th>
                                <th>Icon</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var item = Model[i];
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td>@item.MenuName</td>
                                    <td>@item.MenuUrl</td>
                                    <td><i class="@item.MenuIcon"></i></td>
                                    <td class="text-center">
                                        <a href="javascript:void(0);" class="btn delete-table me-2 edit-Menu-link" data-bs-toggle="modal" data-bs-target="#editMenuModal" data-id="@item.MenuId">
                                            <i class="fe fe-edit"></i>
                                        </a>
                                        <a href="javascript:void(0);" class="btn delete-table delete-Menu-link" data-bs-toggle="modal" data-bs-target="#deleteMenuModal" data-id="@item.MenuId">
                                            <i class="fe fe-trash-2"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= (int)ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("GetAllMenus", new { pageNumber = i })">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addMenuModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="addMenuContent"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editMenuModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editMenuContent"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteMenuModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteMenuContent"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script type="text/javascript">
    $(document).ready(function () {

        function handleAjaxFormSubmission(formId, modalId) {
            $(document).on('submit', formId, function (e) {
                e.preventDefault();

                var form = $(this);
                var formData = form.serialize();
                var submitBtn = form.find('button[type="submit"]');
                var originalBtnHtml = submitBtn.html();

                // Disable button and show spinner
                submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');

                $.ajax({
                    url: form.attr('action'),
                    method: 'POST',
                    data: formData,
                    success: function (result) {
                        if ($(result).find(formId).length > 0) {
                            // Re-render form with validation messages
                            $(modalId + ' .modal-body').html(result);
                        } else {
                            // Success
                            $(modalId).modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Operation completed successfully!',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred. Please try again.',
                        });
                    },
                    complete: function () {
                        submitBtn.prop('disabled', false).html(originalBtnHtml);
                    }
                });
            });
        }

        // Load Create form
        $('#openAddMenuModal').on('click', function () {
            $.get('/Menu/MenusCreate', function (data) {
                $('#addMenuContent').html(data);
                $('#addMenuModal').modal('show');
            });
        });

        // Apply to Create
        handleAjaxFormSubmission('#menuCreateForm', '#addMenuModal');

        // Load Edit form
        $(document).on('click', '.edit-Menu-link', function () {
            var id = $(this).data('id');
            $.get('/Menu/MenusEdit/' + id, function (data) {
                $('#editMenuContent').html(data);
                $('#editMenuModal').modal('show');
            });
        });

        // Apply to Edit
        handleAjaxFormSubmission('#menuEditForm', '#editMenuModal');

        // Load Delete form
        $(document).on('click', '.delete-Menu-link', function () {
            var id = $(this).data('id');
            $.get('/Menu/MenusDelete?id=' + id, function (data) {
                $('#deleteMenuContent').html(data);
                $('#deleteMenuModal').modal('show');
            });
        });

        // Apply to Delete
        handleAjaxFormSubmission('#menuDeleteForm', '#deleteMenuModal');
    });
</script>
}