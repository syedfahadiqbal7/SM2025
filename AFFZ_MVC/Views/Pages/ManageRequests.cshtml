@using System.Web
@model IEnumerable<AFFZ_Customer.Controllers.EligibilityRequestDTO>
@{
    ViewData["Title"] = "Manage Eligibility Requests";
}
<style>
    .custom-table {
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

        .custom-table th, .custom-table td {
            padding: 12px;
            text-align: left;
        }

        .custom-table tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }

        .custom-table tbody tr:hover {
            background-color: #f1f1f1;
        }

    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modal-lg {
        max-width: 800px;
    }

    .btn-close {
        filter: invert(1);
    }
</style>
<div class="col-lg-9">
    <h2 class="mb-4">Manage Eligibility Requests</h2>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["FailMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-times-circle me-2"></i>@TempData["FailMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="table-responsive">
        <table class="table table-hover custom-table" id="data-table">
            <thead class="table-light text-white sticky-header">
                <tr>
                    <th>Service</th>
                    <th>Require Service For</th>
                    <th>Request Details</th>
                    <th>Request Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                    <th>Process</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var request in Model)
                {
                    var statusLower = request.Status.StatusName.ToLower();
                    var createdDate = request.CreatedDate;
                    var isExpired = (DateTime.UtcNow.ToLocalTime() - createdDate).TotalHours > 24;

                    <tr class="align-middle">
                        <td style="text-wrap: auto;">@request.Service.serviceName</td>
                        <td>@request.Nationality</td>
                        <td>
                            <a href="javascript:void(0);" style="color: green;text-transform: math-auto;text-decoration: underline;" onclick="showRequestDetails('@Html.Raw(HttpUtility.JavaScriptStringEncode(request.RequestDetails))')">
                                View Details
                            </a>
                        </td>
                        <td>@createdDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>
                            <span class="badge
                                @(statusLower == "approved" ? "bg-success" :
                                  statusLower == "rejected" ? "bg-danger" :
                                  isExpired ? "bg-secondary" : "bg-warning")">
                                @request.Status.StatusName
                            </span>
                        </td>
                        <td>
                            @if (statusLower == "more info needed" && !isExpired)
                            {
                                <button class="btn btn-outline-warning btn-sm open-modal"
                                        data-request-id="@request.RequestID"
                                        data-existing-details="@request.RequestDetails">
                                    <i class="fas fa-info-circle"></i> Provide More Info
                                </button>
                            }
                            @if (statusLower == "pending" && !isExpired)
                            {
                                <span class="badge bg-primary">Waiting for Merchant Response</span>
                            }
                        </td>

                        <td>
                            @if (statusLower == "approved")
                            {
                                <a href="/MerchantList/SelectedMerchantList?catName=@request.Service.serviceName">Proceed to service</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Updating Request Details -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Provide More Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <input type="hidden" id="requestId" name="requestId" />
                    <label for="requestDetails" class="fw-bold">Existing Details:</label>
                    <textarea id="requestDetails" class="form-control bg-light" rows="4" readonly></textarea>
                    <label for="newDetails" class="mt-3 fw-bold">Add More Information:</label>
                    <textarea id="newDetails" class="form-control mt-2" rows="3" placeholder="Enter additional information"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveDetails">Update Information</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Updating Request Details -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Provide More Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <input type="hidden" id="requestId" name="requestId" />
                    <label for="requestDetails">Additional Details:</label>
                    <textarea id="requestDetails" class="form-control" rows="5" readonly></textarea>
                    <textarea id="newDetails" class="form-control mt-2" rows="3" placeholder="Enter additional information"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveDetails">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Request Details -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="requestDetailsLabel"><i class="fas fa-info-circle me-2"></i> Request Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="requestDetailsText" class="text-muted"></p>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript to Handle Modal -->
@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            $(".open-modal").click(function () {
                var requestId = $(this).data("request-id");
                var existingDetails = $(this).data("existing-details");

                $("#requestId").val(requestId);
                $("#requestDetails").val(existingDetails);
                $("#newDetails").val("");

                $("#updateModal").modal("show");
            });

            $("#saveDetails").click(function () {

                var requestId = $("#requestId").val();
                var newDetails = $("#newDetails").val();
                var existingDetails = $("#requestDetails").val();

                if (newDetails.trim() === "") {
                    alert("Please enter additional information.");
                    return;
                }

                var updatedDetails = existingDetails + "\n\n" + newDetails;
                var elem = document.getElementById("saveDetails");
                elem.disabled = true;
                elem.innerHTML = 'Submitting... <i class="fas fa-spinner fa-spin"></i>';
                $.ajax({
                    url: "/UpdateEligibilityRequest",
                    type: "POST",
                    data: {
                        requestId: requestId,
                        status: "RequestMore",
                        Questions: updatedDetails
                    },
                    success: function (response) {
                        alert("Request updated successfully.");
                        location.reload();
                    },
                    error: function () {
                        alert("An error occurred while updating.");
                    }
                });
            });
        });
        function showRequestDetails(details) {
            $('#requestDetailsText').text(details);
            $('#requestDetailsModal').modal('show');
        }
    </script>
}
